<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerald Setup</title>
  <link rel="stylesheet" href="/setup/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-icon">
        <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="24" cy="24" r="20" stroke="#00ff87" stroke-width="2" fill="none"/>
          <circle cx="17" cy="20" r="2" fill="#00ff87"/>
          <circle cx="31" cy="20" r="2" fill="#00ff87"/>
          <path d="M16 28 Q24 32 32 28" stroke="#00ff87" stroke-width="2" stroke-linecap="round" fill="none"/>
          <path d="M12 12 L18 8 M30 8 L36 12" stroke="#00ff87" stroke-width="2" stroke-linecap="round"/>
          <circle cx="24" cy="4" r="2" fill="#00ff87"/>
        </svg>
      </div>
      <h1 class="header-title">Gerald Setup</h1>
      <p class="header-subtitle">Configure your AI assistant</p>
    </header>

    <!-- Status Card -->
    <div class="card card-fade-in" style="animation-delay: 0.1s">
      <div class="card-header">
        <div class="step-badge">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <circle cx="10" cy="10" r="9" stroke="#00ff87" stroke-width="1.5"/>
            <path d="M7 10l2 2 4-4" stroke="#00ff87" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h2>Status</h2>
      </div>
      <div class="status-content">
        <div id="status" class="status-text">
          <div class="skeleton skeleton-text"></div>
        </div>
        <div class="status-links">
          <a href="/openclaw" target="_blank" class="status-link">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Open Dashboard
          </a>
          <span class="link-divider">‚Ä¢</span>
          <a href="/setup/export" target="_blank" class="status-link">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M8 2v8m0 0l-3-3m3 3l3-3M3 14h10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Download Backup
          </a>
        </div>
      </div>
    </div>

    <!-- Step 1: Model/Auth Provider -->
    <div class="card card-fade-in" style="animation-delay: 0.2s">
      <div class="card-header">
        <div class="step-badge step-number">‚ë†</div>
        <h2>Model & Authentication</h2>
      </div>
      <p class="card-description">Configure your AI model provider and authentication method</p>
      
      <div class="form-group">
        <label for="authGroup">Provider Group</label>
        <div class="select-wrapper">
          <select id="authGroup" class="input-field">
            <div class="skeleton skeleton-select"></div>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="authChoice">Auth Method</label>
        <div class="select-wrapper">
          <select id="authChoice" class="input-field">
            <option value="">Loading...</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="authSecret">API Key / Token</label>
        <input id="authSecret" type="password" class="input-field" placeholder="Paste your API key or token if required" />
      </div>

      <div class="form-group">
        <label for="flow">Wizard Flow</label>
        <div class="select-wrapper">
          <select id="flow" class="input-field">
            <option value="quickstart">Quickstart (recommended)</option>
            <option value="advanced">Advanced</option>
            <option value="manual">Manual</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Step 2: Channels (Collapsible) -->
    <div class="card card-fade-in" style="animation-delay: 0.3s">
      <div class="card-header card-header-collapsible" data-target="channels-content">
        <div class="step-badge step-number">‚ë°</div>
        <h2>Message Channels</h2>
        <span class="optional-badge">Optional</span>
        <button type="button" class="collapse-toggle" aria-label="Toggle section">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div id="channels-content" class="collapsible-content collapsed">
        <p class="card-description">Connect messaging platforms for bot communication</p>
        
        <div class="form-group">
          <label for="telegramToken">Telegram Bot Token</label>
          <input id="telegramToken" type="password" class="input-field" placeholder="123456:ABC..." />
          <p class="field-hint">
            Get it from <code>@BotFather</code>: open Telegram, message <code>@BotFather</code>, run <code>/newbot</code>, then copy the token.
          </p>
        </div>

        <div class="form-group">
          <label for="discordToken">Discord Bot Token</label>
          <input id="discordToken" type="password" class="input-field" placeholder="Bot token" />
          <p class="field-hint">
            Create at <a href="https://discord.com/developers/applications" target="_blank">Discord Developer Portal</a><br/>
            <strong>‚ö†Ô∏è Important:</strong> Enable <strong>MESSAGE CONTENT INTENT</strong> in Bot ‚Üí Privileged Gateway Intents
          </p>
        </div>

        <div class="form-group">
          <label for="slackBotToken">Slack Bot Token</label>
          <input id="slackBotToken" type="password" class="input-field" placeholder="xoxb-..." />
        </div>

        <div class="form-group">
          <label for="slackAppToken">Slack App Token</label>
          <input id="slackAppToken" type="password" class="input-field" placeholder="xapp-..." />
        </div>
      </div>
    </div>

    <!-- Step 3: Client Configuration -->
    <div class="card card-fade-in" style="animation-delay: 0.4s">
      <div class="card-header">
        <div class="step-badge step-number">‚ë¢</div>
        <h2>Client Configuration</h2>
      </div>
      <p class="card-description">Configure this deployment for a specific client website</p>
      
      <div class="form-group">
        <label for="clientDomain">Client Domain</label>
        <input id="clientDomain" type="text" class="input-field" placeholder="example.com" />
        <p class="field-hint">
          The client's primary domain. Auto-configures routing for:<br/>
          <code>clientdomain.com</code> (production) ‚Ä¢ <code>dev.clientdomain.com</code> (staging) ‚Ä¢ <code>gerald.clientdomain.com</code> (chat)<br/>
          <strong>Auto-configured:</strong> DNS records (Cloudflare) ‚Ä¢ Turnstile CAPTCHA keys
        </p>
      </div>

      <div class="form-group">
        <label for="clientName">Client Name</label>
        <input id="clientName" type="text" class="input-field" placeholder="Client Name" />
      </div>

      <div class="form-group">
        <label for="guardrailLevel">Guardrail Level</label>
        <div class="select-wrapper">
          <select id="guardrailLevel" class="input-field">
            <option value="standard">Standard (text + images only)</option>
            <option value="admin">Admin (create/delete pages, limited design)</option>
          </select>
        </div>
      </div>

      <!-- GitHub OAuth Section -->
      <div class="form-group">
        <label>GitHub Integration</label>
        
        <div id="github-section">
          <!-- Not connected state -->
          <div id="github-not-connected">
            <p class="field-hint" style="margin-bottom: 12px;">Connect your GitHub account to access repositories.</p>
            <button type="button" onclick="startGitHubAuth()" class="btn-primary" style="width: 100%;">
              üêô Connect GitHub Account
            </button>
          </div>

          <!-- Auth in progress state -->
          <div id="github-auth-progress" style="display:none">
            <p class="field-hint" style="margin-bottom: 8px;">Enter this code on GitHub:</p>
            <div class="user-code" id="github-user-code">XXXX-XXXX</div>
            <a href="https://github.com/login/device" target="_blank" class="btn-secondary" style="width: 100%; margin-bottom: 12px;">
              Open github.com/login/device ‚Üí
            </a>
            <p class="field-hint">‚è≥ Waiting for authorization...</p>
          </div>

          <!-- Connected state -->
          <div id="github-connected" style="display:none">
            <div class="info-box" style="margin-bottom: 16px;">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 2a8 8 0 100 16 8 8 0 000-16z" fill="#00ff87" fill-opacity="0.1"/>
                <path d="M9 12l-2-2m0 0l2-2m-2 2h6m-6 0a5 5 0 105-5" stroke="#00ff87" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <div>
                <strong>‚úÖ Connected as <span id="github-username">@username</span></strong>
              </div>
            </div>
            
            <div class="form-group">
              <label for="github-repo-select">Website Repository</label>
              <div class="select-wrapper">
                <select id="github-repo-select" class="input-field">
                  <option value="">Select a repository...</option>
                </select>
              </div>
            </div>
            
            <button type="button" onclick="disconnectGitHub()" class="btn-tertiary" style="width: 100%;">
              Disconnect GitHub
            </button>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="prodBranch">Production Branch</label>
          <input id="prodBranch" type="text" class="input-field" placeholder="main" value="main" />
        </div>
        <div class="form-group">
          <label for="devBranch">Development Branch</label>
          <input id="devBranch" type="text" class="input-field" placeholder="development" value="development" />
        </div>
      </div>

      <!-- CLI Authentication Section -->
      <div class="form-group" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(136, 146, 176, 0.1);">
        <label>CLI Authentication (Beta)</label>
        <p class="field-hint" style="margin-bottom: 16px;">
          Enable subscription-based authentication using Claude Code or Codex CLIs. 
          These authenticate via your Claude Pro/Max or ChatGPT Plus/Pro subscriptions.
        </p>

        <!-- Codex (OpenAI) -->
        <div id="codex-section" style="margin-bottom: 20px;">
          <h4 style="color: #00ff87; font-size: 14px; font-weight: 600; margin-bottom: 12px;">
            ü§ñ OpenAI Codex
          </h4>
          
          <!-- Not connected state -->
          <div id="codex-not-connected">
            <p class="field-hint" style="margin-bottom: 12px;">
              Uses your ChatGPT Plus/Pro subscription. Requires device code authentication enabled in your ChatGPT security settings.
            </p>
            <button type="button" onclick="startCodexAuth()" class="btn-primary" style="width: 100%;">
              Connect Codex
            </button>
          </div>

          <!-- Auth in progress state -->
          <div id="codex-auth-progress" style="display:none">
            <p class="field-hint" style="margin-bottom: 8px;">Enter this code on ChatGPT:</p>
            <div class="user-code" id="codex-user-code">XXXX-XXXX</div>
            <a href="" id="codex-verify-link" target="_blank" class="btn-secondary" style="width: 100%; margin-bottom: 12px;">
              Open verification page ‚Üí
            </a>
            <p class="field-hint">‚è≥ Waiting for authorization...</p>
          </div>

          <!-- Connected state -->
          <div id="codex-connected" style="display:none">
            <div class="info-box" style="margin-bottom: 16px;">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 2a8 8 0 100 16 8 8 0 000-16z" fill="#00ff87" fill-opacity="0.1"/>
                <path d="M9 12l-2-2m0 0l2-2m-2 2h6m-6 0a5 5 0 105-5" stroke="#00ff87" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <div>
                <strong>‚úÖ Connected via ChatGPT subscription</strong>
              </div>
            </div>
            <button type="button" onclick="disconnectCodex()" class="btn-tertiary" style="width: 100%;">
              Disconnect Codex
            </button>
          </div>
        </div>

        <!-- Claude Code -->
        <div id="claude-section" style="padding-top: 16px; border-top: 1px solid rgba(136, 146, 176, 0.1);">
          <h4 style="color: #00ff87; font-size: 14px; font-weight: 600; margin-bottom: 12px;">
            üß† Anthropic Claude Code
          </h4>
          
          <!-- Not connected state -->
          <div id="claude-not-connected">
            <p class="field-hint" style="margin-bottom: 12px;">
              Uses your Claude Pro/Max subscription. Manual authentication required via SSH.
            </p>
            <button type="button" onclick="showClaudeInstructions()" class="btn-secondary" style="width: 100%;">
              Show Authentication Instructions
            </button>
          </div>

          <!-- Instructions state -->
          <div id="claude-instructions" style="display:none">
            <div class="info-box" style="margin-bottom: 16px;">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <circle cx="10" cy="10" r="8" stroke="#00b4d8" stroke-width="2" fill="none"/>
                <text x="10" y="14" text-anchor="middle" fill="#00b4d8" font-size="12" font-weight="bold">i</text>
              </svg>
              <div>
                <strong>Manual Authentication Required</strong>
                <p style="margin-top: 8px; font-size: 13px; line-height: 1.5;">
                  1. SSH into your Railway instance<br>
                  2. Run: <code style="background: rgba(0,255,135,0.1); padding: 2px 6px; border-radius: 4px;">claude</code><br>
                  3. Follow the authentication flow in your browser<br>
                  4. Refresh this page to verify connection
                </p>
              </div>
            </div>
            <div style="display: flex; gap: 12px;">
              <button type="button" onclick="checkClaudeStatus()" class="btn-primary" style="flex: 1;">
                ‚úì Check Status
              </button>
              <button type="button" onclick="hideClaudeInstructions()" class="btn-tertiary" style="flex: 1;">
                Hide Instructions
              </button>
            </div>
          </div>

          <!-- Connected state -->
          <div id="claude-connected" style="display:none">
            <div class="info-box" style="margin-bottom: 16px;">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 2a8 8 0 100 16 8 8 0 000-16z" fill="#00ff87" fill-opacity="0.1"/>
                <path d="M9 12l-2-2m0 0l2-2m-2 2h6m-6 0a5 5 0 105-5" stroke="#00ff87" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <div>
                <strong>‚úÖ Connected via Claude subscription</strong>
                <p style="margin-top: 4px; font-size: 13px;">Account: <span id="claude-account">authenticated</span></p>
              </div>
            </div>
            <button type="button" onclick="disconnectClaude()" class="btn-tertiary" style="width: 100%;">
              Disconnect Claude
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 4: Dashboard Authentication -->
    <div class="card card-fade-in" style="animation-delay: 0.5s">
      <div class="card-header">
        <div class="step-badge step-number">‚ë£</div>
        <h2>Dashboard Authentication</h2>
      </div>
      <p class="card-description">Configure magic link authentication via SendGrid</p>
      
      <div class="form-group">
        <label for="sendgridApiKey">SendGrid API Key</label>
        <input id="sendgridApiKey" type="password" class="input-field" placeholder="SG.xxx" />
        <p class="field-hint">
          Required for magic link login emails.
          <a href="https://app.sendgrid.com/settings/api_keys" target="_blank">Get your key ‚Üí</a>
        </p>
      </div>

      <div class="form-group">
        <label for="sendgridSenderEmail">SendGrid Sender Email</label>
        <input id="sendgridSenderEmail" type="email" class="input-field" placeholder="noreply@yourdomain.com" />
        <p class="field-hint">
          The "From" address for login emails. <strong>Domain verification will be handled automatically</strong> when both SendGrid and Cloudflare are configured.
        </p>
      </div>

      <div class="form-group">
        <label for="allowedEmails">Allowed Emails</label>
        <textarea id="allowedEmails" rows="4" class="input-field textarea-field" placeholder="andy@illumin8.ca&#10;admin@yourdomain.com"></textarea>
        <p class="field-hint">One email per line. Only these emails can access the dashboard.</p>
      </div>

    </div>

    <!-- Step 5: Services (Collapsible) -->
    <div class="card card-fade-in" style="animation-delay: 0.6s">
      <div class="card-header card-header-collapsible" data-target="services-content">
        <div class="step-badge step-number">‚ë§</div>
        <h2>Contact Form Services</h2>
        <span class="optional-badge">Optional</span>
        <button type="button" class="collapse-toggle" aria-label="Toggle section">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div id="services-content" class="collapsible-content collapsed">
        <p class="card-description">Configure contact form notifications. Email uses the SendGrid key from Section ‚ë£ above.</p>

        <div class="form-group">
          <label for="contactFromName">Contact Form "From" Name</label>
          <input id="contactFromName" type="text" class="input-field" placeholder="Your Business Name" />
          <p class="field-hint">The sender name shown on contact form notification emails (e.g. "Acme Inc Website").</p>
        </div>
        
        <input id="sendgridKey" type="hidden" />

        <div class="form-group">
          <label for="twilioSid">Twilio Account SID</label>
          <input id="twilioSid" type="text" class="input-field" placeholder="ACxxx" />
        </div>

        <div class="form-group">
          <label for="twilioToken">Twilio Auth Token</label>
          <input id="twilioToken" type="password" class="input-field" placeholder="Auth token" />
        </div>

        <div class="form-group">
          <label for="twilioPhone">Twilio Phone Number</label>
          <input id="twilioPhone" type="text" class="input-field" placeholder="+1234567890" />
          <p class="field-hint">
            For SMS notifications when contact forms are submitted.
            <a href="https://console.twilio.com/" target="_blank">Twilio Console ‚Üí</a>
          </p>
        </div>

        <div class="info-box">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M10 2a8 8 0 100 16 8 8 0 000-16z" fill="#00b4d8" fill-opacity="0.1"/>
            <path d="M10 14v-4m0-4h.01" stroke="#00b4d8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <strong>üõ°Ô∏è Turnstile CAPTCHA</strong> ‚Äî Auto-generated during setup when Cloudflare is configured. No manual setup needed.
            <a href="https://dash.cloudflare.com/?to=/:account/turnstile" target="_blank">Manage ‚Üí</a>
          </div>
        </div>

        <input id="turnstileSiteKey" type="hidden" />
        <input id="turnstileSecretKey" type="hidden" />
      </div>
    </div>

    <!-- Step 6: Run Setup -->
    <div class="card card-fade-in" style="animation-delay: 0.7s">
      <div class="card-header">
        <div class="step-badge step-number">‚ë•</div>
        <h2>Run Setup</h2>
      </div>
      
      <div class="button-group">
        <button id="run" class="btn-primary">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M6 4l10 6-10 6V4z" fill="currentColor"/>
          </svg>
          Run Setup
        </button>
        <button id="pairingApprove" class="btn-secondary">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M16 6l-8 8-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Approve Pairing
        </button>
        <button id="reset" class="btn-tertiary">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M4 10a6 6 0 0112 0M16 10a6 6 0 01-12 0m0 0V6m0 4h4m8 0v4m0-4h-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Reset Setup
        </button>
      </div>

      <pre id="log" class="log-output"></pre>
      
      <p class="field-hint" style="margin-top: 1rem; text-align: center;">
        Reset deletes the OpenClaw config file so you can rerun onboarding. Pairing approval grants DM access when dmPolicy=pairing.
      </p>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <p>Powered by <strong>Gerald AI</strong> ‚Ä¢ OpenClaw Railway Template</p>
    </footer>
  </div>

  <script src="/setup/app.js?v=3"></script>
</body>
</html>
